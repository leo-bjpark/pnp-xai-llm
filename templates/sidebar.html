{# Shared sidebar. Expects: is_index (bool), task (optional), models, models_grouped, xai_level_grouped, tasks, xai_level_names. #}
<aside class="sidebar">
  <div class="sidebar-section">
    <div class="create-task-wrap">
      {% if is_index %}
      <button type="button" class="btn-create-task" id="btn-create-task" title="Hover to choose XAI level">Create XAI</button>
      <div class="create-task-dropdown" id="create-task-dropdown">
        {% for level_num, items in (xai_level_grouped or {}).items() %}
        <div class="create-task-level-group">
          <div class="create-task-level-header">Level {{ level_num }}</div>
          <div class="create-task-rows">
            {% for level, name in items %}
            <button type="button" class="create-task-option create-task-row" data-level="{{ level }}" data-name="{{ name }}">
              <span class="create-task-num">{{ level }}</span>
              <span class="create-task-desc">{{ name }}</span>
            </button>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <a href="/" class="btn-create-task" title="Start new session">Create TASK</a>
      <div class="create-task-dropdown" id="create-task-dropdown">
        {% for level_num, items in (xai_level_grouped or {}).items() %}
        <div class="create-task-level-group">
          <div class="create-task-level-header">Level {{ level_num }}</div>
          <div class="create-task-rows">
            {% for level, name in items %}
            <a href="/?create={{ level }}" class="create-task-option create-task-row">
              <span class="create-task-num">{{ level }}</span>
              <span class="create-task-desc">{{ name }}</span>
            </a>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="sidebar-section {% if is_index %}{% endif %}" {% if is_index %}data-section="loaded-model"{% endif %}>
    <div class="sidebar-section-title sidebar-section-title-loaded">
      {% if is_index %}<span class="sidebar-section-chevron" aria-hidden="true">▼</span>{% endif %}
      <span>Loaded Model</span>
      <button type="button" class="btn-setting" id="btn-cuda-setting" title="CUDA_VISIBLE_DEVICES">Setting</button>
    </div>
    {% if is_index %}<div class="sidebar-section-body">{% endif %}
    <div class="cuda-setting-panel" id="cuda-setting-panel" aria-hidden="true">
      <label for="cuda-visible-devices-input" class="cuda-setting-label">CUDA_VISIBLE_DEVICES</label>
      <div class="cuda-setting-input-row">
        <input type="text" id="cuda-visible-devices-input" class="sidebar-input cuda-setting-input" placeholder="e.g. 0 or 0,1" />
        <button type="button" class="btn-cuda-export" id="btn-cuda-export">Export</button>
      </div>
      <div class="cuda-setting-echo">
        <span class="cuda-setting-echo-label">ECHO</span>
        <pre class="cuda-setting-echo-value" id="cuda-setting-echo-value">—</pre>
      </div>
    </div>
    <div class="sidebar-model-controls">
      <select id="sidebar-model" class="sidebar-select">
        {% if models_grouped %}
        {% for group, model_list in models_grouped.items() %}
        <optgroup label="{{ group if group else 'Models' }}">
          {% for m in model_list %}
          <option value="{{ m }}" {% if task and task.model == m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </optgroup>
        {% endfor %}
        {% else %}
        {% for m in models %}
        <option value="{{ m }}" {% if task and task.model == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
        {% endif %}
      </select>
      <button type="button" class="btn-load-model" id="btn-load-model">Load</button>
    </div>
    <div class="loaded-model-display {% if task and task.model %}has-model{% endif %}" id="loaded-model-display">
      <span id="loaded-model-text">{% if task and task.model %}{{ task.model }}{% else %}—{% endif %}</span>
    </div>
    {% if is_index %}</div>{% endif %}
  </div>

  <div class="sidebar-section" {% if is_index %}data-section="treatments"{% endif %}>
    <div class="sidebar-section-title">
      {% if is_index %}<span class="sidebar-section-chevron" aria-hidden="true">▼</span>{% endif %}
      <span>Treatments</span>
    </div>
    {% if is_index %}<div class="sidebar-section-body">{% endif %}
    <div class="sidebar-treatment-header-row">
      <div class="create-treatment-wrap">
        <button
          type="button"
          class="btn-create-treatment"
          id="btn-create-treatment"
          title="Hover to choose Steering type"
        >
          Steering
        </button>
        <div class="create-treatment-dropdown" id="create-treatment-dropdown">
          <button
            type="button"
            class="create-treatment-option"
            data-treatment-type="simple_steering"
          >
            Simple Steering (Residual)
          </button>
        </div>
      </div>
      <span class="treatment-status" id="treatment-status-indicator" title="Steering status">
        Simple Steering: Inactive
      </span>
    </div>
    <input type="hidden" id="sidebar-treatment" />
    {% if is_index %}</div>{% endif %}
  </div>

  <div class="sidebar-section" {% if is_index %}data-section="task-panels"{% endif %}>
    <div class="sidebar-section-title">
      {% if is_index %}<span class="sidebar-section-chevron" aria-hidden="true">▼</span>{% endif %}
      <span>Created Task Panels</span>
    </div>
    {% if is_index %}<div class="sidebar-section-body">{% endif %}
    <ul class="task-panel-list" id="task-panel-list">
      {% for level, items in tasks.items() if items %}
      <li class="task-panel-group">
        <div class="task-panel-group-title">
          {% if is_index %}<span class="task-panel-chevron" aria-hidden="true">▼</span>{% endif %}
          <span class="task-panel-group-label">{% set level_key = level.replace('xai_level_', '').replace('_', '.') %}{{ level_key }}{% if xai_level_names %} — {{ xai_level_names.get(level_key, '') }}{% endif %}</span>
        </div>
        <ul class="task-panel-sublist">
          {% for t in items %}
          <li class="task-panel-item {% if task and t.id == task.id %}active{% endif %}" data-task-id="{{ t.id }}" data-level="{{ level }}">
            <a href="/task/{{ t.id }}" class="task-panel-item-link">{{ t.title }}</a>
            <button type="button" class="task-panel-delete" data-task-id="{{ t.id }}" title="Delete">×</button>
          </li>
          {% endfor %}
        </ul>
      </li>
      {% else %}
      <li class="task-panel-empty">No tasks created yet.</li>
      {% endfor %}
    </ul>
    {% if is_index %}</div>{% endif %}
  </div>

  <div class="sidebar-section" {% if is_index %}data-section="data-management"{% endif %}>
    <div class="sidebar-section-title">
      {% if is_index %}<span class="sidebar-section-chevron" aria-hidden="true">▼</span>{% endif %}
      <span>Data Management</span>
    </div>
    {% if is_index %}<div class="sidebar-section-body">{% endif %}
    <div class="sidebar-data-management-header">
      <span class="sidebar-data-label">Dataset Pipeline</span>
      <button type="button" class="btn-create-pipeline" id="btn-create-pipeline" title="New pipeline">+ New</button>
    </div>
    <ul class="dataset-pipeline-list" id="dataset-pipeline-list">
      {% for p in (dataset_pipelines or []) %}
      <li class="dataset-pipeline-item {% if pipeline and p.id == pipeline.id %}active{% endif %}" data-pipeline-id="{{ p.id }}">
        <a href="/data/{{ p.id }}" class="dataset-pipeline-link">{{ p.name }} --- {{ p.status }}</a>
        <button type="button" class="dataset-pipeline-delete" data-pipeline-id="{{ p.id }}" title="Delete">×</button>
      </li>
      {% else %}
      <li class="dataset-pipeline-empty">No pipelines yet.</li>
      {% endfor %}
    </ul>
    {% if is_index %}</div>{% endif %}
  </div>

  <div class="sidebar-section" {% if is_index %}data-section="variable-cache"{% endif %}>
    <div class="sidebar-section-title">
      {% if is_index %}<span class="sidebar-section-chevron" aria-hidden="true">▼</span>{% endif %}
      <span>Variable Cache</span>
    </div>
    {% if is_index %}<div class="sidebar-section-body">{% endif %}
    <ul class="sidebar-variable-list" id="sidebar-variable-list">
      <li class="sidebar-variable-empty" id="sidebar-variable-empty">No variables.</li>
    </ul>
    {% if is_index %}</div>{% endif %}
  </div>
</aside>

{# Treatment editor panel: rendered next to sidebar inside main-layout #}
{% include '_treatment_panel.html' %}
