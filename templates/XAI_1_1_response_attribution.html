<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ task.title }} - PnP-XAI-LLM</title>
  <script>document.documentElement.dataset.theme=localStorage.getItem('pnp-xai-theme')||'light';</script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ide.css') }}" />
</head>
<body>
  {% set export_as_link = true %}
  {% include 'header.html' with context %}

  <div class="main-layout">
    {% set is_index = false %}
    {% include 'sidebar.html' with context %}

    <main class="content-area">
      <div class="content-toolbar">
        <button type="button" class="btn-run" id="btn-run">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
          RUN
        </button>
        <span id="generation-status" class="generation-status" aria-live="polite"></span>
        <button type="button" class="input-setting-trigger" id="input-setting-trigger" title="Task, Model, Treatment, Name" data-task-type="Response Attribution" data-task-name="{{ task.name or task.title or '' }}" data-task-model="{{ task.model or '' }}" data-task-treatment="{{ task.treatment or '' }}">
          Response Attribution | {{ task.model or '—' }} | {{ task.treatment or 'None' }} | {{ task.name or task.title or '—' }}
        </button>
      </div>

      <div class="input-setting-panel" id="input-setting-panel">
        <div class="input-setting-body" id="input-setting-body">
          <p class="input-setting-hint">Response Attribution: Chat Template (system + user). Set System Instruction and Input String; attribution is over all input tokens before generation. RUN then highlights contributing tokens (input_grad).</p>
          <div class="input-setting-form input-setting-form-row attribution-input-form">
            <div class="input-setting-cell">
              <label for="input-completion-temperature">Temperature</label>
              <input type="number" id="input-completion-temperature" name="temperature" data-task-input="temperature" class="input-setting-field" min="0" max="2" step="0.1" value="{{ (task.result or {}).get('temperature', 0.7) }}" />
            </div>
            <div class="input-setting-cell">
              <label for="input-completion-max-new-tokens">Max new tokens</label>
              <input type="number" id="input-completion-max-new-tokens" name="max_new_tokens" data-task-input="max_new_tokens" class="input-setting-field" min="1" max="4096" step="1" value="{{ (task.result or {}).get('max_new_tokens', 256) }}" />
            </div>
            <div class="input-setting-cell">
              <label for="input-completion-top-p">Top-P</label>
              <input type="number" id="input-completion-top-p" name="top_p" data-task-input="top_p" class="input-setting-field" min="0" max="1" step="0.05" value="{{ (task.result or {}).get('top_p', 1.0) }}" />
            </div>
            <div class="input-setting-cell">
              <label for="input-completion-top-k">Top-K</label>
              <input type="number" id="input-completion-top-k" name="top_k" data-task-input="top_k" class="input-setting-field" min="0" max="1000" step="1" value="{{ (task.result or {}).get('top_k', 50) }}" />
            </div>
            <div class="input-setting-cell">
              <label for="input-completion-attribution-method">Attribution method</label>
              <select id="input-completion-attribution-method" name="attribution_method" data-task-input="attribution_method" class="input-setting-field">
                <option value="">None</option>
                <option value="input_grad" {{ 'selected' if (task.result or {}).get('attribution_method', 'input_grad') == 'input_grad' else '' }}>input_grad</option>
              </select>
            </div>
            <div class="attribution-system-input-row">
              <div class="input-setting-cell attribution-system-cell">
                <label for="input-attribution-system-instruction">System Instruction</label>
                <textarea id="input-attribution-system-instruction" name="system_instruction" data-task-input="system_instruction" class="input-setting-field input-setting-textarea attribution-dual-height" rows="8" placeholder="You are a helpful assistant.">{{ (task.result or {}).get('system_instruction', 'You are a helpful assistant.') }}</textarea>
              </div>
              <div class="input-setting-cell input-string-cell attribution-input-cell">
                <label for="input-completion-string">Input String</label>
                <div class="input-string-trigger" id="input-string-trigger" role="button" tabindex="0" title="Click for multi-line editor">Enter prompt...</div>
                <textarea id="input-completion-string" name="input_string" data-task-input="input_string" class="input-setting-field input-string-textarea attribution-dual-height" rows="8" placeholder="Enter prompt for completion..." style="display:none;">{{ (task.result or {}).get('input_string', '') }}</textarea>
                <div class="input-string-backdrop" id="input-string-backdrop"></div>
                <div class="input-string-popover" id="input-string-popover">
                  <textarea id="input-string-popover-textarea" class="input-string-popover-textarea" rows="10" placeholder="Enter prompt for completion..."></textarea>
                  <button type="button" class="input-string-popover-close" id="input-string-popover-close">Done</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="results-area">
        {% if task.result and (task.result or {}).get('token_scores') is not none and (task.result or {}).get('input_tokens') is not none %}
        <div class="results-content visible" id="results-content">
          <div class="results-completion-wrap results-attribution-wrap">
            <h3>Input attribution</h3>
            <div class="attribution-range-row">
              <div class="attribution-range-controls">
                <label class="attribution-range-label">min_clip</label>
                <input type="color" class="attribution-color-left" value="#e8e8e8" title="Low (min) color" aria-label="Low color">
                <div class="attribution-range-slider-wrap">
                  <div class="attribution-range-track" id="attribution-range-track"></div>
                  <input type="range" class="attribution-range-min" min="0" max="1" step="0.01" value="0" aria-label="min_clip">
                  <input type="range" class="attribution-range-max" min="0" max="1" step="0.01" value="1" aria-label="max_clip">
                </div>
                <input type="color" class="attribution-color-right" value="#3b82f6" title="High (max) color" aria-label="High color">
                <label class="attribution-range-label">max_clip</label>
                <span class="attribution-range-values" id="attribution-range-values">0.00 — 1.00</span>
              </div>
              <div class="attribution-kde-chart" id="attribution-kde-chart" aria-label="Score distribution (KDE)">
                <svg viewBox="0 0 220 100" preserveAspectRatio="xMidYMid meet">
                  <g class="kde-axis">
                    <line x1="28" y1="8" x2="28" y2="72" class="kde-yline"/>
                    <line x1="28" y1="72" x2="212" y2="72" class="kde-xline"/>
                    <text x="28" y="80" text-anchor="middle">0</text>
                    <text x="212" y="80" text-anchor="middle">1</text>
                    <text x="120" y="94" text-anchor="middle" class="kde-axis-label">Value</text>
                    <text x="14" y="40" text-anchor="middle" class="kde-axis-label" transform="rotate(-90,14,40)">Density</text>
                  </g>
                  <path class="kde-path" d="M28,72 L212,72 L212,72 L28,72 Z"/>
                </svg>
              </div>
            </div>
            <div class="attribution-tokens-wrap" id="attribution-tokens-wrap">
              {% set _tokens = (task.result or {}).get('input_tokens', []) %}
              {% set _scores = (task.result or {}).get('token_scores', []) %}
              {% for token in _tokens %}
              {% set _idx = loop.index0 %}
              {% set _score = _scores[_idx] if _idx < _scores|length else 0 %}
              <span class="attribution-token" data-score="{{ _score }}" title="score: {{ _score }}">{{ token }}</span>
              {% endfor %}
            </div>
            <div class="attribution-tokens-drop-special-wrap">
              <div class="attribution-tokens-drop-special-label">Special tokens dropped</div>
              <div class="attribution-tokens-wrap" id="attribution-tokens-wrap-drop-special">
                {% set _scores_drop = (task.result or {}).get('token_scores_drop_special') or _scores %}
                {% for token in _tokens %}
                {% set _idx = loop.index0 %}
                {% set _sd = _scores_drop[_idx] if _idx < _scores_drop|length else 0 %}
                <span class="attribution-token" data-score="{{ _sd }}" title="score: {{ _sd }}">{{ token }}</span>
                {% endfor %}
              </div>
            </div>
            <h3>Generated</h3>
            <pre class="results-completion-text">{{ task.result.generated_text }}</pre>
            <details class="results-completion-meta">
              <summary>Parameters &amp; full result</summary>
              <pre class="results-json">{{ task.result | tojson(indent=2) }}</pre>
            </details>
          </div>
        </div>
        <div class="results-placeholder hidden" id="results-placeholder"></div>
        {% elif task.result and (task.result or {}).get('generated_text') is not none %}
        <div class="results-content visible" id="results-content">
          <div class="results-completion-wrap">
            <h3>Generated</h3>
            <pre class="results-completion-text">{{ task.result.generated_text }}</pre>
            <details class="results-completion-meta">
              <summary>Parameters &amp; full result</summary>
              <pre class="results-json">{{ task.result | tojson(indent=2) }}</pre>
            </details>
          </div>
        </div>
        <div class="results-placeholder hidden" id="results-placeholder"></div>
        {% else %}
        <div class="results-placeholder" id="results-placeholder">
          <span class="brand-title">PnP-XAI-LLM</span>
          <ul class="feature-list">
            <li>Response Attribution: set Input String and RUN to see which input tokens contributed to the output.</li>
            <li>Attribution method: input_grad (gradient of output w.r.t. input, abs, normalized 0–1).</li>
          </ul>
        </div>
        <div class="results-content" id="results-content"></div>
        {% endif %}
      </div>
    </main>
  </div>

  <div class="modal-overlay" id="modal-confirm-load">
    <div class="modal-dialog">
      <h3>Confirm Model Load</h3>
      <p id="modal-message">Loaded Model + Treatment does not match the current session. Load the model with this setting?</p>
      <div class="modal-actions">
        <button type="button" class="modal-btn-cancel" id="modal-cancel">Cancel</button>
        <button type="button" class="modal-btn-confirm" id="modal-confirm">Load</button>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
  <script src="{{ url_for('static', filename='js/xai_1/input_attribution_kde_vis.js') }}"></script>
  <script src="{{ url_for('static', filename='js/xai_1/input_attribution_gradient_control.js') }}"></script>
  <script>window.PNP_CURRENT_TASK_ID = {{ task.id | tojson }}; window.PNP_CURRENT_TASK_LEVEL = {{ task.xai_level | tojson }};</script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  <script>
  (function() {
    var realEl = document.getElementById("input-completion-string");
    var trigger = document.getElementById("input-string-trigger");
    var popover = document.getElementById("input-string-popover");
    var backdrop = document.getElementById("input-string-backdrop");
    var popoverTa = document.getElementById("input-string-popover-textarea");
    var closeBtn = document.getElementById("input-string-popover-close");
    function updateTriggerText() {
      if (!trigger) return;
      var v = (realEl && realEl.value) ? realEl.value.trim() : "";
      trigger.textContent = v || "Enter prompt...";
    }
    function openPopover() {
      if (popoverTa && realEl) popoverTa.value = realEl.value || "";
      if (popover) popover.classList.add("visible");
      if (backdrop) backdrop.classList.add("visible");
      if (popoverTa) { popoverTa.focus(); popoverTa.select(); }
    }
    function closePopover() {
      if (popover) popover.classList.remove("visible");
      if (backdrop) backdrop.classList.remove("visible");
      if (realEl && popoverTa) realEl.value = popoverTa.value || "";
      updateTriggerText();
    }
    if (trigger) {
      trigger.addEventListener("click", openPopover);
      trigger.addEventListener("keydown", function(e) { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openPopover(); } });
    }
    if (closeBtn) closeBtn.addEventListener("click", closePopover);
    if (backdrop) backdrop.addEventListener("click", closePopover);
    document.addEventListener("keydown", function(e) { if (e.key === "Escape" && popover && popover.classList.contains("visible")) { e.preventDefault(); closePopover(); } });
    updateTriggerText();
  })();
  </script>
</body>
</html>
